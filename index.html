<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPCM Operations Monitor</title>
    
    <!-- iOS SETTINGS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RPCM Monitor">
    
    <!-- ANDROID SETTINGS -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#111827">
    
    <!-- APP ICON -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/512/factory.png">
    <link rel="icon" type="image/png" sizes="192x192" href="https://img.icons8.com/fluency/192/factory.png">
    <link rel="icon" type="image/png" sizes="512x512" href="https://img.icons8.com/fluency/512/factory.png">
    
    <!-- React & ReactDOM (Load First) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Recharts Dependencies (Crucial Order) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.5.0/umd/Recharts.js"></script>
    
    <!-- SheetJS for Excel Processing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, onSnapshot };
    </script>
    
    <!-- Tailwind Config -->
    <script>
        try {
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' },
                            plant: { green: '#8cc63f', orange: '#f59e0b', red: '#ef4444', blue: '#3b82f6', dark: '#111827' }
                        },
                        fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['Fira Code', 'monospace'] }
                    }
                }
            }
        } catch (e) { console.warn("Tailwind config issue", e); }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        /* Recharts Override */
        .recharts-cartesian-grid-horizontal line, .recharts-cartesian-grid-vertical line { stroke: #374151; }
        .recharts-text { fill: #9ca3af; font-size: 11px; }
        /* Gauge Animation */
        .gauge-path { transition: stroke-dashoffset 1s ease-out; }
        .recharts-tooltip-wrapper { z-index: 50; }
        /* Refresh Button Animation */
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
            animation: spin-slow 2s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        // Safe destructuring
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area, ReferenceLine } = window.Recharts || {};

        // --- CONFIG ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyB5gFPpiFHvG4LnF2KhDQVa6R98cTb-cfA",
            authDomain: "rpcm-dashboard.firebaseapp.com",
            projectId: "rpcm-dashboard",
            storageBucket: "rpcm-dashboard.firebasestorage.app",
            messagingSenderId: "718536830642",
            appId: "1:718536830642:web:7c34bf37017efe40e5a3ab",
            measurementId: "G-V7Y09MT8ET"
        };

        let activeConfig = null;
        let configSource = 'offline';
        if (USER_FIREBASE_CONFIG) { activeConfig = USER_FIREBASE_CONFIG; configSource = 'user'; } 
        else if (typeof __firebase_config !== 'undefined') { try { activeConfig = JSON.parse(__firebase_config); configSource = 'canvas'; } catch(e) {} }

        // --- ICONS ---
        const Icons = {
            Zap: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Activity: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
            Thermometer: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>,
            GaugeIcon: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>,
            Droplet: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22a7 7 0 0 0 7-7c0-2-2-3-2-3l-5-8-5 8s-2 1-2 3a7 7 0 0 0 7 7z"/></svg>,
            Droplets: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></svg>,
            LayoutDashboard: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></svg>,
            Settings: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Bell: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>,
            Menu: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
            Calendar: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Box: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
            ShieldAlert: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            TrendingUp: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            Upload: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Cloud: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
            RefreshCw: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"/><path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        };

        // --- REUSABLE COMPONENTS ---
        const RpcmLogo = ({ className }) => (
            <svg viewBox="0 0 200 180" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M100 5 L190 50 V140 L100 185 L10 140 V50 L100 5Z" stroke="currentColor" strokeWidth="12" strokeLinejoin="round"/>
                <path d="M25 65 L175 65" stroke="currentColor" strokeWidth="2" opacity="0.5"/> 
                <path d="M25 125 L175 125" stroke="currentColor" strokeWidth="2" opacity="0.5"/>
                <text x="100" y="115" textAnchor="middle" fill="currentColor" fontSize="52" fontWeight="bold" fontFamily="Arial, sans-serif" letterSpacing="2">RPCM</text>
            </svg>
        );

        const Gauge = ({ value, max, title, unit, color, icon: Icon }) => {
            const normalizedValue = Math.min(Math.max(value || 0, 0), max);
            const percentage = normalizedValue / max;
            const [displayVal, setDisplayVal] = useState(0);

            useEffect(() => {
                setDisplayVal(value || 0);
            }, [value]);

            return (
                <div className="bg-gray-900 border border-gray-800 rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 flex flex-col items-center relative overflow-hidden group">
                    <div className="flex items-center justify-between w-full mb-4 z-10">
                        <div className="flex items-center gap-2 text-gray-400 text-sm font-medium uppercase tracking-wider"><span>{title}</span></div>
                        <div className="flex items-center gap-1"><div className={`w-2 h-2 rounded-full ${percentage > 0.9 ? 'bg-plant-red animate-pulse' : 'bg-plant-green'}`}></div></div>
                    </div>
                    <div className="relative w-48 h-28 z-10">
                        <svg viewBox="0 0 200 110" className="w-full h-full">
                            <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#374151" strokeWidth={12} strokeLinecap="round"/>
                            <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke={`url(#gradient-${title.replace(/[^a-zA-Z0-9]/g, '')})`} strokeWidth={12} strokeLinecap="round" strokeDasharray={`${Math.PI * 80}`} strokeDashoffset={`${Math.PI * 80 * (1 - percentage)}`} className="gauge-path transition-[stroke-dashoffset] duration-1000 ease-out"/>
                            <defs><linearGradient id={`gradient-${title.replace(/[^a-zA-Z0-9]/g, '')}`} x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stopColor={color === 'text-plant-green' ? '#8cc63f' : color === 'text-plant-orange' ? '#d97706' : '#2563eb'} /><stop offset="100%" stopColor={color === 'text-plant-green' ? '#a3d95b' : color === 'text-plant-orange' ? '#fbbf24' : '#60a5fa'} /></linearGradient></defs>
                        </svg>
                        <div className="absolute bottom-3 left-0 text-xs text-gray-500 font-mono font-bold">0</div>
                        <div className="absolute bottom-3 right-0 text-xs text-gray-500 font-mono font-bold">{max}</div>
                        <div className="absolute bottom-0 left-0 right-0 text-center transform translate-y-1">
                            <div className={`text-3xl font-bold ${color} font-mono`}>{displayVal?.toFixed(2)}</div>
                            <div className="text-gray-500 text-sm font-medium">{unit}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const ProductionCard = ({ title, actual, target, unit }) => {
            const percent = target > 0 ? (actual / target) * 100 : 0;
            const isLow = percent < 90; 
            return (
                <div className="bg-gray-900 border border-gray-800 rounded-xl p-5 shadow-lg">
                    <div className="text-gray-400 text-xs uppercase tracking-wider mb-2 font-medium">{title}</div>
                    <div className="flex justify-between items-end mb-2">
                        <div><span className="text-2xl font-bold text-white">{actual?.toLocaleString() || 0}</span><span className="text-sm text-gray-500 ml-1">{unit}</span></div>
                        <div className="text-right"><div className="text-xs text-gray-500">Target</div><div className="text-sm font-medium text-gray-300">{target?.toLocaleString() || 0}</div></div>
                    </div>
                    <div className="w-full bg-gray-800 rounded-full h-1.5 overflow-hidden"><div className={`h-full rounded-full ${isLow ? 'bg-plant-red' : 'bg-plant-green'}`} style={{ width: `${Math.min(percent, 100)}%` }}></div></div>
                    <div className="mt-2 text-xs flex justify-between"><span className={isLow ? "text-red-400" : "text-green-400"}>{percent.toFixed(1)}% Achieved</span></div>
                </div>
            );
        };

        const KpiRow = ({ label, value, target, unit, inverse = false }) => {
            const diff = ((value - target) / target) * 100;
            const isGood = inverse ? value <= target : value >= target;
            return (
                <div className="flex justify-between items-center py-3 border-b border-gray-800 last:border-0">
                    <span className="text-sm text-gray-300">{label}</span>
                    <div className="flex items-center gap-4">
                        <div className="text-right"><div className="text-sm font-mono font-bold text-white">{value || 0} <span className="text-gray-500 text-xs">{unit}</span></div><div className="text-xs text-gray-500">tgt: {target}</div></div>
                        <div className={`text-xs px-2 py-1 rounded font-medium w-16 text-center ${isGood ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`}>{isGood ? 'OK' : `${Math.abs(diff || 0).toFixed(1)}%`}</div>
                    </div>
                </div>
            );
        };

        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return (
                    <div className="bg-gray-800 p-3 border border-gray-700 rounded shadow-lg text-xs z-50">
                        <p className="text-gray-400 mb-1 font-bold">{label}</p>
                        {payload.map((pld, idx) => (
                            <div key={idx} style={{ color: pld.color }} className="flex items-center gap-2">
                                <span>{pld.name}:</span>
                                <span className="font-mono font-bold">{pld.value}</span>
                            </div>
                        ))}
                    </div>
                );
            }
            return null;
        };

        // --- MAIN DASHBOARD ---
        const Dashboard = () => {
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [chartView, setChartView] = useState('production');
            const fileInputRef = useRef(null);
            const [lastUpdated, setLastUpdated] = useState('Initializing...');
            const [user, setUser] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [isCloudAvailable, setIsCloudAvailable] = useState(false);
            const [isRefreshing, setIsRefreshing] = useState(false);

            const [dashboardData, setDashboardData] = useState({
                production: [{ id: 'cta', title: 'CTA Production', actual: 0, target: 1808, unit: 'tonnes' }, { id: 'pta', title: 'PTA Production', actual: 0, target: 1857, unit: 'tonnes' }],
                availability: { actual: 0, target: 97.0 },
                metrics: {
                    power: [
                        { id: 'p1', title: 'Plant Power', value: 0, max: 20, unit: 'MW', icon: 'Zap' }, 
                        { id: 'p2', title: 'Power Gen', value: 0, max: 15, unit: 'MW', icon: 'Zap' },
                        { id: 'p3', title: 'BC101A', value: 0, max: 10, unit: 'MW', icon: 'Zap' },
                        { id: 'p4', title: 'BC101B', value: 0, max: 10, unit: 'MW', icon: 'Zap' }
                    ],
                    steam: [
                        { id: 's1', title: 'Steam FLEXSYS', value: 0, max: 30, unit: 'TPH', icon: 'Thermometer' }, 
                        { id: 's2', title: 'Steam to DHT', value: 0, max: 100, unit: 'TPH', icon: 'Thermometer' },
                        { id: 's3', title: '4.4 Steam Header', value: 0, max: 6, unit: 'kg/cm2', icon: 'GaugeIcon' }
                    ],
                    flow: [
                        { id: 'f1', title: 'PX Rate', value: 0, max: 60, unit: 'TPH', icon: 'Droplet' }, 
                        { id: 'f2', title: 'ADM 1 Flow', value: 0, max: 40, unit: 'TPH', icon: 'Droplets' },
                        { id: 'f3', title: 'ADM 2 Flow', value: 0, max: 60, unit: 'TPH', icon: 'Droplets' }
                    ]
                },
                hsse: { alarms: 0, bypass: 0, limit: 0, leaks: { toxic: 0, hac: 0, hotOil: 0, gas: 0 } },
                efficiency: { power: { val: 0, tgt: 175 }, hac: { val: 0, tgt: 28.3 }, px: { val: 0, tgt: 14.0 }, catalyst: { val: 0, tgt: 0.42 }, wwt: { val: 0, tgt: 200 }, water: { val: 0, unit: 'm3' } },
                hourly: []
            });

            // Refresh function
            const handleRefresh = () => {
                setIsRefreshing(true);
                
                // Simulate refresh action - in real scenario, this would re-fetch from Firebase/local
                setTimeout(() => {
                    if(isCloudAvailable && user && activeConfig) {
                        // In Firebase mode, data should auto-refresh via onSnapshot
                        setLastUpdated("Refreshed from Cloud - " + new Date().toLocaleTimeString());
                    } else {
                        // In local mode, reload from localStorage
                        const stored = localStorage.getItem('rpcm_dashboard_data_v17');
                        if (stored) {
                            try {
                                const parsed = JSON.parse(stored);
                                const merged = {
                                    ...dashboardData,
                                    ...parsed,
                                    metrics: {
                                        power: parsed.metrics?.power || dashboardData.metrics.power,
                                        steam: parsed.metrics?.steam || dashboardData.metrics.steam,
                                        flow: parsed.metrics?.flow || dashboardData.metrics.flow
                                    },
                                    hourly: parsed.hourly || []
                                };
                                setDashboardData(merged);
                                setLastUpdated("Refreshed from Local - " + new Date().toLocaleTimeString());
                            } catch (e) {
                                console.error("Error refreshing from local storage:", e);
                            }
                        }
                    }
                    setIsRefreshing(false);
                }, 1000);
            };

            // Firebase Init
            useEffect(() => {
                const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, onSnapshot } = window.firebaseModules;
                if (activeConfig) {
                    setIsCloudAvailable(true);
                    const app = initializeApp(activeConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    const path = configSource === 'user' ? doc(db, 'dashboard_data', 'live_status') : doc(db, 'artifacts', (typeof __app_id !== 'undefined' ? __app_id : 'default'), 'public', 'data', 'dashboard_state', 'current_state');

                    if (configSource === 'canvas' && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) signInWithCustomToken(auth, __initial_auth_token);
                    else signInAnonymously(auth).catch(() => fallbackToLocal());

                    onAuthStateChanged(auth, (u) => {
                        if (u) {
                            setUser(u);
                            onSnapshot(path, (docSnap) => {
                                if (docSnap.exists()) {
                                    const d = docSnap.data();
                                    const merged = { ...dashboardData, ...d.dashboardData, metrics: { ...dashboardData.metrics, ...d.dashboardData.metrics }, hourly: d.dashboardData.hourly || [] };
                                    setDashboardData(merged);
                                    setLastUpdated(d.lastUpdated);
                                } else setLastUpdated("Waiting for data...");
                            });
                        }
                    });
                } else fallbackToLocal();
            }, []);

            const fallbackToLocal = () => {
                setIsCloudAvailable(false);
                setLastUpdated("Local Mode (Offline)");
                const stored = localStorage.getItem('rpcm_dashboard_data_v17');
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        const merged = {
                            ...dashboardData,
                            ...parsed,
                            metrics: {
                                power: parsed.metrics?.power || dashboardData.metrics.power,
                                steam: parsed.metrics?.steam || dashboardData.metrics.steam,
                                flow: parsed.metrics?.flow || dashboardData.metrics.flow
                            },
                            hourly: parsed.hourly || []
                        };
                        setDashboardData(merged);
                        setLastUpdated("Restored from Local");
                    } catch (e) {}
                }
            };

            // File Upload
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const newData = { ...dashboardData };

                    // 1. Summary Sheet
                    const wsMain = wb.Sheets[wb.SheetNames[0]];
                    if (wsMain) {
                        const raw = XLSX.utils.sheet_to_json(wsMain, { header: 1 });
                        const find = (keys) => {
                            const row = raw.find(r => r[0] && keys.some(k => r[0].toString().toLowerCase().includes(k.toLowerCase())));
                            return row ? { val: parseFloat(row[2]), tgt: parseFloat(row[3]) } : null;
                        };
                        
                        const cta = find(['CTA Prod']); if(cta) newData.production[0].actual = cta.val;
                        const pta = find(['PTA Prod']); if(pta) newData.production[1].actual = pta.val;
                        const avail = find(['Availability']); if(avail) newData.availability.actual = avail.val;
                        
                        const plantP = find(['Plant Power']); if(plantP) newData.metrics.power[0].value = plantP.val;
                        const pGen = find(['Power Gen']); if(pGen) newData.metrics.power[1].value = pGen.val;
                        const bc101a = find(['BC101A']); if(bc101a) newData.metrics.power[2].value = bc101a.val;
                        const bc101b = find(['BC101B']); if(bc101b) newData.metrics.power[3].value = bc101b.val;
                        const sFlex = find(['Steam FLEXSYS']); if(sFlex) newData.metrics.steam[0].value = sFlex.val;
                        const sDht = find(['Steam to DHT']); if(sDht) newData.metrics.steam[1].value = sDht.val;
                        const sHead = find(['4.4 Steam Header']); if(sHead) newData.metrics.steam[2].value = sHead.val;
                        const px = find(['PX Rate']); if(px) newData.metrics.flow[0].value = px.val;
                        const adm1 = find(['ADM 1 Flow']); if(adm1) newData.metrics.flow[1].value = adm1.val;
                        const adm2 = find(['ADM 2 Flow']); if(adm2) newData.metrics.flow[2].value = adm2.val;

                        const effPower = find(['Total Power']); if (effPower) newData.efficiency.power.val = effPower.val;
                        const effHac = find(['HAC Cons']); if (effHac) newData.efficiency.hac.val = effHac.val;
                        const effPx = find(['Excess PX']); if (effPx) newData.efficiency.px.val = effPx.val;
                        const effCat = find(['CMB Catalyst']); if (effCat) newData.efficiency.catalyst.val = effCat.val;
                        const effWwt = find(['WWT COD']); if (effWwt) newData.efficiency.wwt.val = effWwt.val;
                        const effWater = find(['Demin Water']); if (effWater) newData.efficiency.water.val = effWater.val;
                    }

                    // 2. Hourly Logs Sheet (Robust)
                    let wsHourly = wb.Sheets["Hourly Logs"] || wb.Sheets[wb.SheetNames[1]];
                    if (wsHourly) {
                        const rawHourly = XLSX.utils.sheet_to_json(wsHourly);
                        newData.hourly = rawHourly.map(row => {
                            const getVal = (keys) => {
                                const key = Object.keys(row).find(k => keys.some(s => k.toLowerCase().includes(s.toLowerCase())));
                                return key ? parseFloat(row[key]) || 0 : 0;
                            };
                            
                            let timeVal = row['Time'];
                            if (typeof timeVal === 'number') {
                                const totalSeconds = Math.floor(timeVal * 86400);
                                const hours = Math.floor(totalSeconds / 3600);
                                const minutes = Math.floor((totalSeconds % 3600) / 60);
                                timeVal = `${hours}:${minutes < 10 ? '0' : ''}${minutes}`;
                            }

                            return {
                                time: timeVal || '',
                                plantPower: getVal(['Plant Power']),
                                powerGen: getVal(['Power Gen']),
                                steamFlex: getVal(['Steam FLEXSYS']),
                                pxRate: getVal(['PX rate']),
                                bc101a: getVal(['BC101A']),
                                bc101b: getVal(['BC101B']),
                                steamDht: getVal(['Steam DHT', 'Steam to DHT']),
                                header44: getVal(['4.4 Header', '4.4 steam header']),
                                liveHeader: getVal(['Live Header']),
                                adm2: getVal(['ADM2', 'ADM 2', 'ADM2 Flow BE401 makeup']),
                                adm1: getVal(['ADM1', 'ADM 1', 'ADM1 Flow BD911 makeup'])
                            };
                        }).filter(r => r.time); 
                    }

                    const today = new Date().toLocaleString();
                    setDashboardData(newData);
                    setLastUpdated(today);
                    
                    if(isCloudAvailable && user && activeConfig) {
                        const { getFirestore, doc, setDoc } = window.firebaseModules;
                        const db = getFirestore();
                        const path = configSource === 'user' ? doc(db, 'dashboard_data', 'live_status') : doc(db, 'artifacts', (typeof __app_id !== 'undefined' ? __app_id : 'default'), 'public', 'data', 'dashboard_state', 'current_state');
                        await setDoc(path, { dashboardData: newData, lastUpdated: today });
                        alert("Synced!");
                    } else {
                        localStorage.setItem('rpcm_dashboard_data_v17', JSON.stringify(newData));
                        alert("Saved Locally");
                    }
                };
                reader.readAsBinaryString(file);
            };
            
            return (
                <div className="flex h-screen overflow-hidden bg-black text-gray-100 font-sans">
                    <input type="file" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                    
                    {/* Header */}
                    <div className="flex-1 flex flex-col h-full">
                         <header className="h-16 border-b border-gray-800 flex items-center justify-between px-6 bg-gray-900/50">
                            <div className="flex items-center gap-4">
                                <RpcmLogo className="w-8 h-8 text-plant-green" />
                                <div><h1 className="font-bold text-white">RPCM Monitor</h1><p className="text-xs text-gray-400">{lastUpdated}</p></div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button 
                                    onClick={handleRefresh}
                                    disabled={isRefreshing}
                                    className="bg-gray-700 hover:bg-gray-600 disabled:bg-gray-800 text-white px-3 py-2 rounded text-sm font-medium flex items-center gap-2 transition-colors"
                                >
                                    <Icons.RefreshCw className={`w-4 h-4 ${isRefreshing ? 'animate-spin-slow' : ''}`} />
                                    Refresh
                                </button>
                                <button 
                                    onClick={() => fileInputRef.current.click()} 
                                    className="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded text-sm font-medium flex items-center gap-2"
                                >
                                    <Icons.Upload className="w-4 h-4" />
                                </button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            {/* Summary Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {dashboardData.production.map(p => <ProductionCard key={p.id} {...p} />)}
                                <div className="bg-gray-900 border border-gray-800 rounded-xl p-5 shadow-lg flex flex-col justify-between">
                                    <div><div className="text-gray-400 text-xs uppercase tracking-wider mb-1 font-medium">Plant Availability</div><div className="text-3xl font-bold text-white">{dashboardData.availability.actual}%</div></div>
                                    <div className="w-full bg-gray-800 rounded-full h-1.5 mt-2"><div className="h-full bg-plant-orange rounded-full" style={{width: `${dashboardData.availability.actual}%`}}></div></div>
                                </div>
                            </div>

                            {/* Real-Time Gauges */}
                            <div>
                                <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><div className="w-1 h-5 bg-plant-blue rounded-full"></div> Average 12hrs Data</h2>
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {[...dashboardData.metrics.power, ...dashboardData.metrics.steam, ...dashboardData.metrics.flow].map((m, i) => (
                                        <Gauge key={i} {...m} color={i < 4 ? "text-plant-green" : i < 7 ? "text-plant-orange" : "text-plant-blue"} icon={Icons.Activity} />
                                    ))}
                                </div>
                            </div>

                            {/* Hourly Trends - Enhanced UI */}
                            <div className="bg-gray-900 border border-gray-800 rounded-xl p-6 h-[450px] flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-white flex items-center gap-2"><Icons.TrendingUp className="text-plant-green w-5 h-5" /> Hourly Trends (12h)</h3>
                                    <div className="flex bg-gray-800 rounded-lg p-1">
                                        {['production', 'energy', 'steam'].map(mode => (
                                            <button key={mode} onClick={() => setChartView(mode)} className={`px-3 py-1 text-xs font-medium rounded-md capitalize transition-all ${chartView === mode ? 'bg-indigo-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}>{mode}</button>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex-grow w-full min-h-0">
                                    {window.Recharts ? (
                                    <ResponsiveContainer width="100%" height="100%">
                                        <AreaChart data={dashboardData.hourly} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
                                            <defs>
                                                <linearGradient id="colorGreen" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#10b981" stopOpacity={0.3}/><stop offset="95%" stopColor="#10b981" stopOpacity={0}/></linearGradient>
                                                <linearGradient id="colorBlue" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3}/><stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/></linearGradient>
                                                <linearGradient id="colorOrange" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#f59e0b" stopOpacity={0.3}/><stop offset="95%" stopColor="#f59e0b" stopOpacity={0}/></linearGradient>
                                                <linearGradient id="colorPurple" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#8b5cf6" stopOpacity={0.3}/><stop offset="95%" stopColor="#8b5cf6" stopOpacity={0}/></linearGradient>
                                                <linearGradient id="colorRed" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#ef4444" stopOpacity={0.3}/><stop offset="95%" stopColor="#ef4444" stopOpacity={0}/></linearGradient>
                                                <linearGradient id="colorCyan" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#06b6d4" stopOpacity={0.3}/><stop offset="95%" stopColor="#06b6d4" stopOpacity={0}/></linearGradient>
                                            </defs>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#374151" vertical={false} />
                                            <XAxis dataKey="time" stroke="#9ca3af" tick={{fontSize: 11}} tickLine={false} axisLine={false} interval={1} />
                                            <YAxis stroke="#9ca3af" tick={{fontSize: 11}} tickLine={false} axisLine={false} width={30} />
                                            <Tooltip content={<CustomTooltip />} />
                                            <Legend iconType="circle" wrapperStyle={{fontSize: '12px', paddingTop: '10px'}} />
                                            
                                            {chartView === 'production' && (
                                                <>
                                                    <Area type="monotone" dataKey="pxRate" name="PX Rate" stroke="#10b981" strokeWidth={2} fillOpacity={1} fill="url(#colorGreen)" />
                                                    <Area type="monotone" dataKey="adm1" name="ADM 1" stroke="#3b82f6" strokeWidth={2} fillOpacity={1} fill="url(#colorBlue)" />
                                                    <Area type="monotone" dataKey="adm2" name="ADM 2" stroke="#8b5cf6" strokeWidth={2} fillOpacity={1} fill="url(#colorPurple)" />
                                                    <ReferenceLine y={60} stroke="#059669" strokeDasharray="3 3" label="Target" isFront={true} ifOverflow="extendDomain" />
                                                </>
                                            )}
                                            
                                            {chartView === 'energy' && (
                                                <>
                                                    <Area type="monotone" dataKey="plantPower" name="Plant Power" stroke="#f59e0b" strokeWidth={2} fillOpacity={1} fill="url(#colorOrange)" />
                                                    <Area type="monotone" dataKey="powerGen" name="Power Gen" stroke="#10b981" strokeWidth={2} fillOpacity={1} fill="url(#colorGreen)" />
                                                    <Area type="monotone" dataKey="bc101a" name="BC101A" stroke="#6366f1" strokeWidth={2} fillOpacity={1} fill="url(#colorBlue)" />
                                                    <Area type="monotone" dataKey="bc101b" name="BC101B" stroke="#ec4899" strokeWidth={2} fillOpacity={1} fill="url(#colorPurple)" />
                                                </>
                                            )}

                                            {chartView === 'steam' && (
                                                <>
                                                    <Area type="monotone" dataKey="steamFlex" name="Steam FLEX" stroke="#f97316" strokeWidth={2} fillOpacity={1} fill="url(#colorOrange)" />
                                                    <Area type="monotone" dataKey="steamDht" name="Steam DHT" stroke="#ef4444" strokeWidth={2} fillOpacity={1} fill="url(#colorRed)" />
                                                    <Area type="monotone" dataKey="header44" name="4.4 Header" stroke="#06b6d4" strokeWidth={2} fillOpacity={1} fill="url(#colorCyan)" />
                                                </>
                                            )}
                                        </AreaChart>
                                    </ResponsiveContainer>
                                    ) : <div className="flex items-center justify-center h-full text-gray-500">Loading Charts...</div>}
                                </div>
                            </div>
                            
                            {/* Bottom Row */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                {/* HSSE */}
                                <div className="bg-gray-900 border border-gray-800 rounded-xl p-6">
                                    <div className="flex items-center gap-2 mb-4 border-b border-gray-800 pb-4"><Icons.ShieldAlert className="text-plant-red w-5 h-5" /><h3 className="font-bold text-white">HSSE KPI</h3></div>
                                    <div className="space-y-3">
                                        <div className="flex justify-between"><span className="text-gray-400 text-sm">DCS Alarm</span><span className="text-green-400 font-mono">{dashboardData.hsse.alarms}</span></div>
                                        <div className="flex justify-between"><span className="text-gray-400 text-sm">Safety Bypass</span><span className="text-orange-400 font-mono">{dashboardData.hsse.bypass}</span></div>
                                        <div className="flex justify-between"><span className="text-gray-400 text-sm">Operating Limit</span><span className="text-red-400 font-mono">{dashboardData.hsse.limit}</span></div>
                                    </div>
                                </div>
                                {/* Efficiency */}
                                <div className="lg:col-span-2 bg-gray-900 border border-gray-800 rounded-xl p-6">
                                    <div className="flex items-center gap-2 mb-4 border-b border-gray-800 pb-4"><Icons.Activity className="text-plant-blue w-5 h-5" /><h3 className="font-bold text-white">Efficiency</h3></div>
                                    <div className="grid grid-cols-2 gap-8">
                                        <div>
                                            <h4 className="text-xs text-gray-500 uppercase mb-2 font-semibold">Oxidation</h4>
                                            <KpiRow label="Total Power" value={dashboardData.efficiency?.power?.val} target={dashboardData.efficiency?.power?.tgt} unit="kwh/t" inverse={true} />
                                            <KpiRow label="HAC Cons" value={dashboardData.efficiency?.hac?.val} target={dashboardData.efficiency?.hac?.tgt} unit="kg/t" inverse={true} />
                                        </div>
                                        <div>
                                            <h4 className="text-xs text-gray-500 uppercase mb-2 font-semibold">Utilities</h4>
                                            <KpiRow label="WWT COD" value={dashboardData.efficiency?.wwt?.val} target={dashboardData.efficiency?.wwt?.tgt} unit="ppm" inverse={true} />
                                            <div className="py-2 flex justify-between"><span className="text-sm text-gray-300">Demin Water</span><span className="text-white font-mono font-bold">{dashboardData.efficiency?.water?.val} m3</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>



