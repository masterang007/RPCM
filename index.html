<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPCM Operations Monitor</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- SheetJS for Excel Processing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase to global scope safely
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, getFirestore, doc, setDoc, onSnapshot };
    </script>
    
    <!-- Tailwind Config for Custom Colors -->
    <script>
        try {
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            gray: { 750: '#2d3748', 850: '#1a202c', 950: '#0d1117' },
                            plant: { green: '#8cc63f', orange: '#f59e0b', red: '#ef4444', blue: '#3b82f6', dark: '#111827' }
                        },
                        fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['Fira Code', 'monospace'] }
                    }
                }
            }
        } catch (e) { console.warn("Tailwind config issue", e); }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .chart-line { stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: drawLine 2s ease-out forwards; }
        @keyframes drawLine { to { stroke-dashoffset: 0; } }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icons Components ---
        const Icons = {
            Zap: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Activity: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
            Thermometer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/></svg>,
            GaugeIcon: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 14 4-4"/><path d="M3.34 19a10 10 0 1 1 17.32 0"/></svg>,
            Droplet: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22a7 7 0 0 0 7-7c0-2-2-3-2-3l-5-8-5 8s-2 1-2 3a7 7 0 0 0 7 7z"/></svg>,
            Droplets: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></svg>,
            LayoutDashboard: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Bell: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            Menu: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>,
            Calendar: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Box: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
            ShieldAlert: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            TrendingUp: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            Upload: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Cloud: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>
        };

        // --- LOGO ---
        const RpcmLogo = ({ className }) => (
            <svg viewBox="0 0 200 180" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M100 5 L190 50 V140 L100 185 L10 140 V50 L100 5Z" stroke="currentColor" strokeWidth="12" strokeLinejoin="round"/>
                <path d="M25 65 L175 65" stroke="currentColor" strokeWidth="2" opacity="0.5"/> 
                <path d="M25 125 L175 125" stroke="currentColor" strokeWidth="2" opacity="0.5"/>
                <text x="100" y="115" textAnchor="middle" fill="currentColor" fontSize="52" fontWeight="bold" fontFamily="Arial, sans-serif" letterSpacing="2">RPCM</text>
            </svg>
        );

        // --- COMPONENTS ---
        const Gauge = ({ value, max, title, unit, color, icon: Icon }) => {
            const normalizedValue = Math.min(Math.max(value, 0), max);
            const [displayValue, setDisplayValue] = useState(0);
            useEffect(() => {
                let start = 0; const duration = 1500; const startTime = performance.now();
                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const ease = 1 - Math.pow(1 - progress, 4);
                    setDisplayValue(start + (value - start) * ease);
                    if (progress < 1) requestAnimationFrame(animate);
                };
                requestAnimationFrame(animate);
            }, [value, max]);
            const percentage = normalizedValue / max;
            return (
                <div className="bg-gray-900 border border-gray-800 rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow duration-300 flex flex-col items-center relative overflow-hidden group">
                    <div className="flex items-center justify-between w-full mb-4 z-10">
                        <div className="flex items-center gap-2 text-gray-400 text-sm font-medium uppercase tracking-wider"><span>{title}</span></div>
                        <div className="flex items-center gap-1"><div className={`w-2 h-2 rounded-full ${percentage > 0.9 ? 'bg-plant-red animate-pulse' : 'bg-plant-green'}`}></div></div>
                    </div>
                    <div className="relative w-48 h-28 z-10">
                        <svg viewBox="0 0 200 110" className="w-full h-full">
                            <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke="#374151" strokeWidth="12" strokeLinecap="round"/>
                            <path d="M 20 100 A 80 80 0 0 1 180 100" fill="none" stroke={`url(#gradient-${title.replace(/[^a-zA-Z0-9]/g, '')})`} strokeWidth="12" strokeLinecap="round" strokeDasharray={`${Math.PI * 80}`} strokeDashoffset={`${Math.PI * 80 * (1 - percentage)}`} className="gauge-path"/>
                            <defs><linearGradient id={`gradient-${title.replace(/[^a-zA-Z0-9]/g, '')}`} x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stopColor={color === 'text-plant-green' ? '#8cc63f' : color === 'text-plant-orange' ? '#d97706' : '#2563eb'} /><stop offset="100%" stopColor={color === 'text-plant-green' ? '#a3d95b' : color === 'text-plant-orange' ? '#fbbf24' : '#60a5fa'} /></linearGradient></defs>
                        </svg>
                        <div className="absolute bottom-3 left-0 text-xs text-gray-500 font-mono font-bold">0</div>
                        <div className="absolute bottom-3 right-0 text-xs text-gray-500 font-mono font-bold">{max}</div>
                        <div className="absolute bottom-0 left-0 right-0 text-center transform translate-y-1">
                            <div className={`text-3xl font-bold ${color} font-mono`}>{displayValue.toFixed(2)}</div>
                            <div className="text-gray-500 text-sm font-medium">{unit}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const TrendChart = ({ data, dataKey, color, unit }) => {
            const height = 200; const width = 800; const padding = 40;
            const values = data.map(d => d[dataKey]);
            const minVal = Math.min(...values) * 0.9; const maxVal = Math.max(...values) * 1.1;
            const getX = (index) => padding + (index * (width - padding * 2)) / (data.length - 1);
            const getY = (value) => height - padding - ((value - minVal) / (maxVal - minVal)) * (height - padding * 2);
            const points = data.map((d, i) => `${getX(i)},${getY(d[dataKey])}`).join(' ');
            return (
                <div className="w-full overflow-x-auto">
                    <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-full min-w-[600px]">
                        <line x1={padding} y1={height - padding} x2={width - padding} y2={height - padding} stroke="#374151" strokeWidth="1" />
                        <line x1={padding} y1={padding} x2={padding} y2={height - padding} stroke="#374151" strokeWidth="1" />
                        <polyline points={points} fill="none" stroke={color} strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="chart-line"/>
                        {data.map((d, i) => (<g key={i} className="group"><circle cx={getX(i)} cy={getY(d[dataKey])} r="4" fill={color} className="transition-all group-hover:r-6" /><text x={getX(i)} y={getY(d[dataKey]) - 20} textAnchor="middle" fill="white" fontSize="10" className="opacity-0 group-hover:opacity-100 transition-opacity">{d[dataKey]}</text><text x={getX(i)} y={height - 10} textAnchor="middle" fill="#9ca3af" fontSize="10">{d.time}</text></g>))}
                    </svg>
                </div>
            );
        };

        const ProductionCard = ({ title, actual, target, unit }) => {
            const percent = (actual / target) * 100;
            const isLow = percent < 90; 
            return (
                <div className="bg-gray-900 border border-gray-800 rounded-xl p-5 shadow-lg">
                    <div className="text-gray-400 text-xs uppercase tracking-wider mb-2 font-medium">{title}</div>
                    <div className="flex justify-between items-end mb-2">
                        <div><span className="text-2xl font-bold text-white">{actual.toLocaleString()}</span><span className="text-sm text-gray-500 ml-1">{unit}</span></div>
                        <div className="text-right"><div className="text-xs text-gray-500">Target</div><div className="text-sm font-medium text-gray-300">{target.toLocaleString()}</div></div>
                    </div>
                    <div className="w-full bg-gray-800 rounded-full h-1.5 overflow-hidden"><div className={`h-full rounded-full ${isLow ? 'bg-plant-red' : 'bg-plant-green'}`} style={{ width: `${Math.min(percent, 100)}%` }}></div></div>
                    <div className="mt-2 text-xs flex justify-between"><span className={isLow ? "text-red-400" : "text-green-400"}>{percent.toFixed(1)}% Achieved</span></div>
                </div>
            );
        };

        const KpiRow = ({ label, value, target, unit, inverse = false }) => {
            const diff = ((value - target) / target) * 100;
            const isGood = inverse ? value <= target : value >= target;
            return (
                <div className="flex justify-between items-center py-3 border-b border-gray-800 last:border-0">
                    <span className="text-sm text-gray-300">{label}</span>
                    <div className="flex items-center gap-4">
                        <div className="text-right"><div className="text-sm font-mono font-bold text-white">{value} <span className="text-gray-500 text-xs">{unit}</span></div><div className="text-xs text-gray-500">tgt: {target}</div></div>
                        <div className={`text-xs px-2 py-1 rounded font-medium w-16 text-center ${isGood ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`}>{isGood ? 'OK' : `${Math.abs(diff).toFixed(1)}%`}</div>
                    </div>
                </div>
            );
        };

        // --- MAIN DASHBOARD ---
        const Dashboard = () => {
            const [isSidebarOpen, setSidebarOpen] = useState(false);
            const [trendTab, setTrendTab] = useState('power');
            const fileInputRef = useRef(null);
            const [lastUpdated, setLastUpdated] = useState('Initializing...');
            const [user, setUser] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [isCloudAvailable, setIsCloudAvailable] = useState(false);

            // Initial Data
            const initialData = {
                production: [{ id: 'cta', title: 'CTA Production', actual: 0, target: 1808, unit: 'tonnes' }, { id: 'pta', title: 'PTA Production', actual: 0, target: 1857, unit: 'tonnes' }],
                availability: { actual: 0, target: 97.0 },
                metrics: {
                    power: [{ id: 'p1', title: 'Plant Power', value: 0, max: 20, unit: 'MW', icon: 'Zap' }, { id: 'p2', title: 'Power Gen', value: 0, max: 15, unit: 'MW', icon: 'Zap' }],
                    steam: [{ id: 's1', title: 'Steam to DHT', value: 0, max: 100, unit: 'TPH', icon: 'Thermometer' }, { id: 's3', title: '4.4 Steam Header', value: 0, max: 6, unit: 'kg/cm2', icon: 'GaugeIcon' }],
                    flow: [{ id: 'f1', title: 'PX Rate', value: 0, max: 60, unit: 'TPH', icon: 'Droplet' }, { id: 'f2', title: 'ADM 2 Flow', value: 0, max: 60, unit: 'TPH', icon: 'Droplets' }]
                },
                hsse: { alarms: 0, bypass: 0, limit: 0, leaks: { toxic: 0, hac: 0, hotOil: 0, gas: 0 } },
                efficiency: { power: { val: 0, tgt: 175 }, hac: { val: 0, tgt: 28.3 }, px: { val: 0, tgt: 14.0 }, catalyst: { val: 0, tgt: 0.42 }, wwt: { val: 0, tgt: 200 }, water: { val: 0, unit: 'm3' } },
                hourly: []
            };
            const [dashboardData, setDashboardData] = useState(initialData);

            // --- SYSTEM INIT ---
            useEffect(() => {
                // Check if we are in an environment with cloud keys
                if (typeof __firebase_config !== 'undefined') {
                    // --- CLOUD MODE (CANVAS) ---
                    setIsCloudAvailable(true);
                    const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, onSnapshot } = window.firebaseModules;
                    
                    try {
                        const firebaseConfig = JSON.parse(__firebase_config);
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const db = getFirestore(app);
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                        const initAuth = async () => {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        };
                        initAuth();

                        onAuthStateChanged(auth, (u) => {
                            if (u) {
                                setUser(u);
                                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'dashboard_state', 'current_state');
                                onSnapshot(docRef, (docSnap) => {
                                    if (docSnap.exists()) {
                                        const data = docSnap.data();
                                        setDashboardData(data.dashboardData);
                                        setLastUpdated(data.lastUpdated);
                                    } else {
                                        setLastUpdated("No cloud data yet.");
                                    }
                                });
                            }
                        });
                    } catch (e) {
                        console.error("Cloud init failed", e);
                        fallbackToLocal();
                    }
                } else {
                    // --- OFFLINE MODE (NETLIFY / LOCAL) ---
                    fallbackToLocal();
                }
            }, []);

            const fallbackToLocal = () => {
                setIsCloudAvailable(false);
                setLastUpdated("Local Mode (No Cloud)");
                const stored = localStorage.getItem('rpcm_dashboard_data_v3');
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        setDashboardData(parsed);
                        setLastUpdated("Restored from Local");
                    } catch (e) {}
                }
            };

            // --- FILE UPLOAD HANDLER ---
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsSyncing(true);

                const reader = new FileReader();
                reader.onload = async (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsName = wb.SheetNames[0];
                    const ws = wb.Sheets[wsName];
                    const rawData = XLSX.utils.sheet_to_json(ws, { header: 1 });

                    const findValue = (keywords) => {
                        for (let row of rawData) {
                            if (!row[0]) continue;
                            const cellText = row[0].toString().toLowerCase();
                            if (keywords.some(k => cellText.includes(k.toLowerCase()))) {
                                for (let i = 1; i < row.length; i++) {
                                    if (row[i] && !isNaN(parseFloat(row[i]))) return parseFloat(row[i]);
                                }
                            }
                        }
                        return null;
                    };

                    const newData = { ...dashboardData };
                    // Parsing Logic
                    const ctaVal = findValue(['CTA Production', 'CTA Actual']); if (ctaVal) newData.production[0].actual = ctaVal;
                    const ptaVal = findValue(['PTA Production', 'PTA Actual']); if (ptaVal) newData.production[1].actual = ptaVal;
                    const availVal = findValue(['Availability', 'Plant Availability']); if (availVal) newData.availability.actual = availVal;
                    const powerVal = findValue(['Plant Power']); if (powerVal) newData.metrics.power[0].value = powerVal;
                    const steamVal = findValue(['Steam to DHT']); if (steamVal) newData.metrics.steam[0].value = steamVal;
                    const pxVal = findValue(['PX Rate']); if (pxVal) newData.metrics.flow[0].value = pxVal;
                    const alarmVal = findValue(['DCS Alarm']); if (alarmVal !== null) newData.hsse.alarms = alarmVal;
                    const bypassVal = findValue(['Safety Bypass']); if (bypassVal !== null) newData.hsse.bypass = bypassVal;
                    const limitVal = findValue(['Beyond Operating Limit']); if (limitVal !== null) newData.hsse.limit = limitVal;
                    const effPower = findValue(['Total Power']); if (effPower !== null) newData.efficiency.power.val = effPower;
                    const effHac = findValue(['HAC Cons']); if (effHac !== null) newData.efficiency.hac.val = effHac;
                    const effPx = findValue(['Excess PX']); if (effPx !== null) newData.efficiency.px.val = effPx;
                    const effCat = findValue(['CMB Catalyst']); if (effCat !== null) newData.efficiency.catalyst.val = effCat;
                    const effWwt = findValue(['WWT COD']); if (effWwt !== null) newData.efficiency.wwt.val = effWwt;
                    const effWater = findValue(['Demin Water']); if (effWater !== null) newData.efficiency.water.val = effWater;

                    const today = new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                    setDashboardData(newData);
                    setLastUpdated(today);

                    // SAVE (Cloud or Local)
                    if (isCloudAvailable && user) {
                        try {
                            const { getFirestore, doc, setDoc } = window.firebaseModules;
                            const firebaseConfig = JSON.parse(__firebase_config);
                            const app = window.firebaseModules.initializeApp(firebaseConfig);
                            const db = getFirestore(app);
                            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'dashboard_state', 'current_state'), {
                                dashboardData: newData,
                                lastUpdated: today,
                                updatedBy: user.uid
                            });
                            alert("Synced to Cloud!");
                        } catch (e) {
                            console.error(e);
                            localStorage.setItem('rpcm_dashboard_data_v3', JSON.stringify(newData));
                            alert("Cloud save failed. Saved locally.");
                        }
                    } else {
                        localStorage.setItem('rpcm_dashboard_data_v3', JSON.stringify(newData));
                        alert("Saved locally (Offline Mode).");
                    }
                    setIsSyncing(false);
                };
                reader.readAsBinaryString(file);
            };

            const triggerUpload = () => { fileInputRef.current.click(); };

            return (
                <div className="flex h-screen overflow-hidden bg-black">
                    <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".xlsx, .xls" className="hidden" />
                    {/* Sidebar */}
                    <aside className="hidden md:flex w-64 flex-col border-r border-gray-800 bg-gray-900">
                        <div className="h-20 flex items-center px-6 border-b border-gray-800">
                            <div className="flex items-center gap-3 text-plant-green font-bold text-xl tracking-wider"><RpcmLogo className="w-10 h-10" /><div className="flex flex-col"><span>RPCM</span><span className="text-[10px] text-gray-400 font-normal tracking-normal leading-none">RP CHEMICALS</span></div></div>
                        </div>
                        <nav className="flex-1 p-4 space-y-2">
                            <a href="#" className="flex items-center gap-3 px-4 py-3 bg-gray-800 text-white rounded-lg border border-gray-700 shadow-sm"><Icons.LayoutDashboard size={20} /><span className="font-medium">Overview</span></a>
                            <a href="#" className="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors"><Icons.TrendingUp size={20} /><span className="font-medium">Hourly Trends</span></a>
                            <a href="#" className="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors"><Icons.Calendar size={20} /><span className="font-medium">Reports</span></a>
                            <a href="#" className="flex items-center gap-3 px-4 py-3 text-gray-400 hover:bg-gray-800 hover:text-white rounded-lg transition-colors"><Icons.Settings size={20} /><span className="font-medium">Settings</span></a>
                        </nav>
                    </aside>
                    {/* Main */}
                    <main className="flex-1 flex flex-col overflow-hidden relative">
                        <header className="h-16 border-b border-gray-800 bg-gray-900/50 backdrop-blur-md flex items-center justify-between px-6 sticky top-0 z-20">
                            <div className="flex items-center gap-4">
                                <button className="md:hidden text-gray-400" onClick={() => setSidebarOpen(!isSidebarOpen)}><Icons.Menu /></button>
                                <div className="flex items-center gap-3">
                                    <div className="md:hidden"><RpcmLogo className="w-8 h-8 text-plant-green" /></div>
                                    <div><h1 className="text-lg font-semibold text-white">Plant Overview</h1><p className="text-xs text-gray-400">Report Date: {lastUpdated}</p></div>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <button onClick={triggerUpload} className={`flex items-center gap-2 px-3 py-1.5 ${isSyncing ? 'bg-gray-600 cursor-wait' : 'bg-plant-blue hover:bg-blue-600'} text-white rounded-md text-sm font-medium transition-colors`}><Icons.Upload size={16} /><span className="hidden sm:inline">{isSyncing ? 'Syncing...' : 'Import Report'}</span></button>
                                <button className="p-2 text-gray-400 hover:text-white relative"><Icons.Bell size={20} /><span className="absolute top-2 right-2 w-2 h-2 bg-plant-red rounded-full border-2 border-gray-900"></span></button>
                            </div>
                        </header>
                        <div className="flex-1 overflow-y-auto p-6">
                            <div className="max-w-7xl mx-auto space-y-8">
                                {/* Sections */}
                                <section><div className="flex items-center gap-2 mb-4"><Icons.Box size={20} className="text-white" /><h2 className="text-lg font-bold text-white">Daily Production Report</h2></div><div className="grid grid-cols-1 md:grid-cols-3 gap-6">{dashboardData.production.map(p => <ProductionCard key={p.id} {...p} />)}<div className="bg-gray-900 border border-gray-800 rounded-xl p-5 shadow-lg flex flex-col justify-between"><div><div className="text-gray-400 text-xs uppercase tracking-wider mb-1 font-medium">Plant Availability</div><div className="text-3xl font-bold text-white">{dashboardData.availability.actual}%</div></div><div><div className="text-xs text-gray-500">Target: {dashboardData.availability.target}%</div><div className="w-full bg-gray-800 rounded-full h-1.5 mt-2 overflow-hidden"><div className="h-full bg-plant-orange rounded-full" style={{width: `${Math.min(dashboardData.availability.actual, 100)}%`}}></div></div><div className="text-xs text-orange-400 mt-1">Status</div></div></div></div></section>
                                <section><div className="flex items-center gap-2 mb-4"><div className="w-1 h-6 bg-plant-blue rounded-full"></div><h2 className="text-lg font-bold text-white">Real-Time Monitoring</h2></div><div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">{dashboardData.metrics.power.map(m => <Gauge key={m.id} {...m} color="text-plant-green" icon={Icons[m.icon]} />)}{dashboardData.metrics.steam.map(m => <Gauge key={m.id} {...m} color="text-plant-orange" icon={Icons[m.icon]} />)}{dashboardData.metrics.flow.map(m => <Gauge key={m.id} {...m} color="text-plant-blue" icon={Icons[m.icon]} />)}</div></section>
                                <section className="bg-gray-900 border border-gray-800 rounded-xl p-6"><div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 gap-4"><div className="flex items-center gap-2"><Icons.TrendingUp className="text-plant-green" /><h3 className="font-bold text-white">Hourly Trends (06:00 - 18:00)</h3></div><div className="flex gap-2 bg-gray-800 p-1 rounded-lg"><button onClick={() => setTrendTab('power')} className={`px-4 py-1.5 rounded text-xs font-medium transition-colors ${trendTab === 'power' ? 'bg-plant-green text-white shadow' : 'text-gray-400 hover:text-white'}`}>Power</button><button onClick={() => setTrendTab('steam')} className={`px-4 py-1.5 rounded text-xs font-medium transition-colors ${trendTab === 'steam' ? 'bg-plant-orange text-white shadow' : 'text-gray-400 hover:text-white'}`}>Steam</button><button onClick={() => setTrendTab('flow')} className={`px-4 py-1.5 rounded text-xs font-medium transition-colors ${trendTab === 'flow' ? 'bg-plant-blue text-white shadow' : 'text-gray-400 hover:text-white'}`}>Flow</button></div></div><div className="h-64 w-full">{trendTab === 'power' && <TrendChart data={dashboardData.hourly} dataKey="power" color="#8cc63f" unit="MW" />}{trendTab === 'steam' && <TrendChart data={dashboardData.hourly} dataKey="steam" color="#f59e0b" unit="TPH" />}{trendTab === 'flow' && <TrendChart data={dashboardData.hourly} dataKey="flow" color="#3b82f6" unit="TPH" />}</div></section>
                                <section className="grid grid-cols-1 lg:grid-cols-3 gap-6"><div className="bg-gray-900 border border-gray-800 rounded-xl p-6"><div className="flex items-center gap-2 mb-6 border-b border-gray-800 pb-4"><Icons.ShieldAlert className="text-plant-red" /><h3 className="font-bold text-white">HSSE KPI Tracking</h3></div><div className="space-y-4"><div className="flex justify-between items-center"><span className="text-gray-400 text-sm">DCS Alarm & Interlock</span><span className="text-green-400 font-mono font-bold">{dashboardData.hsse.alarms}</span></div><div className="flex justify-between items-center"><span className="text-gray-400 text-sm">Safety Bypass</span><span className="text-orange-400 font-mono font-bold">{dashboardData.hsse.bypass}</span></div><div className="flex justify-between items-center"><span className="text-gray-400 text-sm">Beyond Operating Limit</span><div className="text-right"><span className="text-red-400 font-mono font-bold">{dashboardData.hsse.limit}</span><span className="text-xs text-gray-600 block">Today</span></div></div></div></div><div className="lg:col-span-2 bg-gray-900 border border-gray-800 rounded-xl p-6"><div className="flex items-center gap-2 mb-6 border-b border-gray-800 pb-4"><Icons.Activity className="text-plant-blue" /><h3 className="font-bold text-white">Consumption Efficiency</h3></div><div className="grid grid-cols-1 md:grid-cols-2 gap-x-8"><div><h4 className="text-xs text-gray-500 uppercase mb-3 font-semibold">Oxidation</h4><KpiRow label="Total Power" value={dashboardData.efficiency.power.val} target={dashboardData.efficiency.power.tgt} unit="kwh/t" inverse={true} /><KpiRow label="HAC Cons." value={dashboardData.efficiency.hac.val} target={dashboardData.efficiency.hac.tgt} unit="kg/t" inverse={true} /><KpiRow label="Excess PX" value={dashboardData.efficiency.px.val} target={dashboardData.efficiency.px.tgt} unit="kg/t" inverse={true} /></div><div><h4 className="text-xs text-gray-500 uppercase mb-3 font-semibold md:mt-0 mt-4">WWT & Utilities</h4><KpiRow label="CMB Catalyst" value={dashboardData.efficiency.catalyst.val} target={dashboardData.efficiency.catalyst.tgt} unit="kg/t" inverse={true} /><KpiRow label="WWT COD" value={dashboardData.efficiency.wwt.val} target={dashboardData.efficiency.wwt.tgt} unit="ppm" inverse={true} /><div className="py-3 flex justify-between items-center"><span className="text-sm text-gray-300">Demin Water ISBL</span><span className="text-white font-mono font-bold">{dashboardData.efficiency.water.val} <span className="text-xs text-gray-500">m3</span></span></div></div></div></div></section>
                            </div>
                            <footer className="mt-12 text-center text-gray-600 text-sm pb-6 flex items-center justify-center gap-2">
                                <p>RPCM Operations Dashboard â€¢ Data Source: {lastUpdated}</p>
                                <div className="flex items-center gap-1.5 px-2 py-1 bg-gray-900 rounded border border-gray-800">
                                    <div className={`w-2 h-2 rounded-full ${isCloudAvailable ? 'bg-green-500' : 'bg-orange-500'}`}></div>
                                    <span className="text-xs text-gray-400">{isCloudAvailable ? 'Live Cloud Sync' : 'Local Mode (Offline)'}</span>
                                </div>
                            </footer>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
